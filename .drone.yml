---
kind: pipeline
type: docker
name: build-and-publish-docker

platform:
  os: linux
  arch: amd64

trigger:
  branch:
  - master
  event:
    exclude:
    - pull_request
    - tag
    - promote
    - rollback
steps:

- name: store-dev-release
  image: registry.cern.ch/docker.io/library/golang:1.13
  environment:
    USERNAME:
      from_secret: cbox_username
    PASSWORD:
      from_secret: cbox_password
  detach: true
  commands:
    - TZ=Europe/Berlin go run tools/create-artifacts/main.go -dev -commit ${DRONE_COMMIT} -goversion `go version | awk '{print $$3}'`
    - curl --fail -X MKCOL "https://cernbox.cern.ch/cernbox/desktop/remote.php/webdav/eos/project/r/reva/www/daily/" -k -u $${USERNAME}:$${PASSWORD}
    - curl --fail -X MKCOL "https://cernbox.cern.ch/cernbox/desktop/remote.php/webdav/eos/project/r/reva/www/daily/`date '+%Y-%m-%d'`" -k -u $${USERNAME}:$${PASSWORD}
    - curl --fail -X MKCOL "https://cernbox.cern.ch/cernbox/desktop/remote.php/webdav/eos/project/r/reva/www/daily/`date '+%Y-%m-%d'`/${DRONE_COMMIT}" -k -u $${USERNAME}:$${PASSWORD}
    - for i in $(ls /drone/src/dist);do curl --fail -X PUT -u $${USERNAME}:$${PASSWORD} https://cernbox.cern.ch/cernbox/desktop/remote.php/webdav/eos/project/r/reva/www/daily/`date '+%Y-%m-%d'`/${DRONE_COMMIT}/$${i} --data-binary @./dist/$${i} ; done

- name: license-scan
  image: registry.cern.ch/docker.io/library/golang:1.13
  environment:
    FOSSA_API_KEY:
      from_secret: fossa_api_key
  detach: true
  commands:
    - wget -qO- https://github.com/fossas/fossa-cli/releases/download/v1.0.11/fossa-cli_1.0.11_linux_amd64.tar.gz | tar xvz -C /go/bin/
    - /go/bin/fossa analyze

- name: build
  image: registry.cern.ch/docker.io/library/golang:1.13
  commands:
    - make ci

- name: lint
  image: registry.cern.ch/docker.io/golangci/golangci-lint:v1.26
  commands:
    - golangci-lint run --timeout 2m0s

- name: license-check
  image: registry.cern.ch/docker.io/library/golang:1.13
  failure: ignore
  environment:
    FOSSA_API_KEY:
      from_secret: fossa_api_key
  commands:
    - wget -qO- https://github.com/fossas/fossa-cli/releases/download/v1.0.11/fossa-cli_1.0.11_linux_amd64.tar.gz | tar xvz -C /go/bin/
    - /go/bin/fossa test --timeout 900

- name: publish-docker-reva-latest
  pull: always
  image: plugins/docker
  settings:
    repo: cs3org/reva
    tags: latest
    dockerfile: Dockerfile.reva
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    custom_dns:
      - 128.142.17.5
      - 128.142.16.5

- name: publish-docker-revad-latest
  pull: always
  image: plugins/docker
  settings:
    repo: cs3org/revad
    tags: latest
    dockerfile: Dockerfile.revad
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    custom_dns:
      - 128.142.17.5
      - 128.142.16.5

- name: publish-docker-revad-eos-latest
  pull: always
  image: plugins/docker
  settings:
    repo: cs3org/revad
    tags: latest-eos
    dockerfile: Dockerfile.revad-eos
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    custom_dns:
      - 128.142.17.5
      - 128.142.16.5

---
kind: pipeline
type: docker
name: build-only

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
    - pull_request

steps:
- name: license-scan
  image: registry.cern.ch/docker.io/library/golang:1.13
  environment:
    FOSSA_API_KEY:
      from_secret: fossa_api_key
  detach: true
  commands:
    - wget -qO- https://github.com/fossas/fossa-cli/releases/download/v1.0.11/fossa-cli_1.0.11_linux_amd64.tar.gz | tar xvz -C /go/bin/
    - /go/bin/fossa analyze

- name: build
  image: registry.cern.ch/docker.io/library/golang:1.13
  commands:
    - make ci

- name: lint
  image: registry.cern.ch/docker.io/golangci/golangci-lint:v1.26
  commands:
    - golangci-lint run --timeout 2m0s

- name: changelog
  image: registry.cern.ch/docker.io/library/golang:1.13
  commands:
    - make release-deps && /go/bin/calens > /dev/null
    - make check-changelog-drone PR=$DRONE_PULL_REQUEST
  environment:
    GITHUB_API_TOKEN:
      from_secret: github_api_token

- name: license-check
  image: registry.cern.ch/docker.io/library/golang:1.13
  failure: ignore
  environment:
    FOSSA_API_KEY:
      from_secret: fossa_api_key
  commands:
    - wget -qO- https://github.com/fossas/fossa-cli/releases/download/v1.0.11/fossa-cli_1.0.11_linux_amd64.tar.gz | tar xvz -C /go/bin/
    - /go/bin/fossa test --timeout 900

---
kind: pipeline
type: docker
name: release

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
    - tag

steps:
- name: license-scan
  image: registry.cern.ch/docker.io/library/golang:1.13
  environment:
    FOSSA_API_KEY:
      from_secret: fossa_api_key
  detach: true
  commands:
    - wget -qO- https://github.com/fossas/fossa-cli/releases/download/v1.0.11/fossa-cli_1.0.11_linux_amd64.tar.gz | tar xvz -C /go/bin/
    - /go/bin/fossa analyze

- name: build
  image: registry.cern.ch/docker.io/library/golang:1.13
  commands:
    - make ci

- name: lint
  # will slow down build slightly. In order to get jsonpb deprecation.
  image: registry.cern.ch/docker.io/golangci/golangci-lint:v1.26.0
  commands:
    - golangci-lint run --timeout 2m0s

- name: license-check
  image: registry.cern.ch/docker.io/library/golang:1.13
  failure: ignore
  environment:
    FOSSA_API_KEY:
      from_secret: fossa_api_key
  commands:
    - wget -qO- https://github.com/fossas/fossa-cli/releases/download/v1.0.11/fossa-cli_1.0.11_linux_amd64.tar.gz | tar xvz -C /go/bin/
    - /go/bin/fossa test --timeout 900

- name: create-dist
  image: registry.cern.ch/docker.io/library/golang:1.13
  commands:
    - go run tools/create-artifacts/main.go -version ${DRONE_TAG} -commit ${DRONE_COMMIT} -goversion `go version | awk '{print $$3}'`

- name: publish
  image: registry.cern.ch/docker.io/plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files: dist/*
    note: changelog/NOTE.md

- name: docker-reva-tag
  pull: always
  image: plugins/docker
  settings:
    repo: cs3org/reva
    tags: ${DRONE_TAG}
    dockerfile: Dockerfile.reva
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    custom_dns:
    - 128.142.17.5
    - 128.142.16.5

- name: docker-revad-tag
  pull: always
  image: plugins/docker
  settings:
    repo: cs3org/revad
    tags: ${DRONE_TAG}
    dockerfile: Dockerfile.revad
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    custom_dns:
    - 128.142.17.5
    - 128.142.16.5

- name: docker-revad-eos-tag
  pull: always
  image: plugins/docker
  settings:
    repo: cs3org/revad
    tags: ${DRONE_TAG}-eos
    dockerfile: Dockerfile.revad-eos
    username:
      from_secret: dockerhub_username
    password:
      from_secret: dockerhub_password
    custom_dns:
    - 128.142.17.5
    - 128.142.16.5

---
kind: pipeline
type: docker
name: litmus-owncloud-old-webdav

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c users.toml

  - name: sleep-for-revad-start
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - sleep 5

  - name: litmus-owncloud-old-webdav
    image: registry.cern.ch/docker.io/owncloud/litmus:latest
    environment:
      LITMUS_URL: http://revad-services:20080/remote.php/webdav
      LITMUS_USERNAME: einstein
      LITMUS_PASSWORD: relativity
      TESTS: basic http copymove props

---
kind: pipeline
type: docker
name: litmus-ocis-old-webdav

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c users.toml

  - name: sleep-for-revad-start
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - sleep 5

  - name: litmus-ocis-old-webdav
    image: registry.cern.ch/docker.io/owncloud/litmus:latest
    environment:
      LITMUS_URL: http://revad-services:20080/remote.php/webdav
      LITMUS_USERNAME: einstein
      LITMUS_PASSWORD: relativity
      TESTS: basic http copymove props

---
kind: pipeline
type: docker
name: litmus-owncloud-new-webdav

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c users.toml

  - name: sleep-for-revad-start
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - sleep 5

  - name: litmus-owncloud-new-webdav
    image: registry.cern.ch/docker.io/owncloud/litmus:latest
    environment:
      # UUID is einstein user, see https://github.com/owncloud/ocis-accounts/blob/8de0530f31ed5ffb0bbb7f7f3471f87f429cb2ea/pkg/service/v0/service.go#L45
      LITMUS_URL: http://revad-services:20080/remote.php/dav/files/4c510ada-c86b-4815-8820-42cdf82c3d51
      LITMUS_USERNAME: einstein
      LITMUS_PASSWORD: relativity
      TESTS: basic http copymove props

---
kind: pipeline
type: docker
name: litmus-ocis-new-webdav

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c users.toml

  - name: sleep-for-revad-start
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - sleep 5

  - name: litmus-ocis-new-webdav
    image: registry.cern.ch/docker.io/owncloud/litmus:latest
    environment:
      # UUID is einstein user, see https://github.com/owncloud/ocis-accounts/blob/8de0530f31ed5ffb0bbb7f7f3471f87f429cb2ea/pkg/service/v0/service.go#L45
      LITMUS_URL: http://revad-services:20080/remote.php/dav/files/4c510ada-c86b-4815-8820-42cdf82c3d51
      LITMUS_USERNAME: einstein
      LITMUS_PASSWORD: relativity
      TESTS: basic http copymove props

---
kind: pipeline
type: docker
name: local-integration-tests-owncloud

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: localAPIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@skipOnOcis-OC-Storage'
      PATH_TO_CORE: '/drone/src/tmp/testrunner'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1

---
kind: pipeline
type: docker
name: local-integration-tests-ocis

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: localAPIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@skipOnOcis-OCIS-Storage'
      PATH_TO_CORE: '/drone/src/tmp/testrunner'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: ocis-integration-tests-1

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 1
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: ocis-integration-tests-2

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 2
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: ocis-integration-tests-3

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 3
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: ocis-integration-tests-4

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 4
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: ocis-integration-tests-5

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 5
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: ocis-integration-tests-6

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-ocis.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-ocis.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOcisStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      DELETE_USER_DATA_CMD: 'rm -rf /drone/src/tmp/reva/data/nodes/root/* /drone/src/tmp/reva/data/nodes/*-*-*-*'
      STORAGE_DRIVER: 'OCIS'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 6
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

---
kind: pipeline
type: docker
name: owncloud-integration-tests-1

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OC-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 1
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1

---
kind: pipeline
type: docker
name: owncloud-integration-tests-2

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OC-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 2
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1

---
kind: pipeline
type: docker
name: owncloud-integration-tests-3

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OC-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 3
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1

---
kind: pipeline
type: docker
name: owncloud-integration-tests-4

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OC-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 4
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1

---
kind: pipeline
type: docker
name: owncloud-integration-tests-5

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OC-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 5
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1

---
kind: pipeline
type: docker
name: owncloud-integration-tests-6

platform:
  os: linux
  arch: amd64

trigger:
  event:
    include:
      - pull_request
      - tag

steps:
  - name: build
    image: registry.cern.ch/docker.io/library/golang:1.13
    commands:
      - make build-ci

  - name: revad-services
    image: registry.cern.ch/docker.io/library/golang:1.13
    detach: true
    commands:
      - cd /drone/src/tests/oc-integration-tests/drone/
      - /drone/src/cmd/revad/revad -c frontend.toml &
      - /drone/src/cmd/revad/revad -c gateway.toml &
      - /drone/src/cmd/revad/revad -c shares.toml &
      - /drone/src/cmd/revad/revad -c storage-home-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-oc-owncloud.toml &
      - /drone/src/cmd/revad/revad -c storage-publiclink-owncloud.toml &
      - /drone/src/cmd/revad/revad -c ldap-users.toml

  - name: clone-oC10-test-repos
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - git clone -b master --depth=1 https://github.com/owncloud/testing.git /drone/src/tmp/testing
      - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /drone/src/tmp/testrunner
      - cd /drone/src/tmp/testrunner
      - git checkout 85da111d5ec5660f7294a789304b4bfc32580d95

  - name: oC10APIAcceptanceTestsOwncloudStorage
    image: registry.cern.ch/docker.io/owncloudci/php:7.4
    commands:
      - cd /drone/src/tmp/testrunner
      - make test-acceptance-api
    environment:
      TEST_SERVER_URL: 'http://revad-services:20080'
      OCIS_REVA_DATA_ROOT: '/drone/src/tmp/reva/data/'
      STORAGE_DRIVER: 'OWNCLOUD'
      SKELETON_DIR: '/drone/src/tmp/testing/data/apiSkeleton'
      TEST_WITH_LDAP: 'true'
      REVA_LDAP_HOSTNAME: 'ldap'
      TEST_REVA: 'true'
      BEHAT_FILTER_TAGS: '~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@provisioning_api-app-required&&~@preview-extension-required&&~@local_storage&&~@skipOnOcis-OC-Storage'
      DIVIDE_INTO_NUM_PARTS: 6
      RUN_PART: 6
      EXPECTED_FAILURES_FILE: '/drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt'

services:
  - 'name': 'ldap'
    'image': 'registry.cern.ch/docker.io/osixia/openldap:1.3.0'
    'pull': 'always'
    'environment':
      LDAP_DOMAIN: 'owncloud.com'
      LDAP_ORGANISATION: 'ownCloud'
      LDAP_ADMIN_PASSWORD: 'admin'
      LDAP_TLS_VERIFY_CLIENT: 'never'
      HOSTNAME: 'ldap'

  - name: redis
    image: registry.cern.ch/docker.io/webhippie/redis
    'pull': 'always'
    'environment':
      REDIS_DATABASES: 1
