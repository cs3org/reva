name: test-reva-cli
on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "*.md"
  push:
    branches:
      - "*"
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go environment
        uses: actions/setup-go@v4
        with:
          go-version-file: go.mod
          cache: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install judo
        run: npm install -g @intuit/judo
      - name: Build reva
        run: make reva
      - name: Build revad
        run: make revad
      - name: Create storage directory
        run: mkdir -p tmp/revalocalstorage/data tmp/revalocalstorage/shares
      - name: Create users.json
        run: |
          cat > tmp/users.json << 'EOF'
          [
            {
              "username": "testuser",
              "id": {
                "idp": "http://localhost:20080",
                "opaque_id": "testuser",
                "type": 1
              },
              "secret": "testpass",
              "display_name": "Test User",
              "mail": "test@example.com",
              "mail_verified": true,
              "groups": ["users"],
              "uid_number": 1000,
              "gid_number": 1000
            }, 
            {
              "username": "testreceivinguser",
              "id": {
                "idp": "http://localhost:20080",
                "opaque_id": "testreceivinguser",
                "type": 1
              },
              "secret": "testpass",
              "display_name": "Test User",
              "mail": "test2@example.com",
              "mail_verified": true,
              "groups": ["users"],
              "uid_number": 1001,
              "gid_number": 1000
            }
          ]
          EOF
      - name: Create groups.json
        run: |
          cat > tmp/groups.json << 'EOF'
          [
            {
              "id": {
                "opaque_id": "users",
                "idp": "http://localhost:20080"
              },
              "group_name": "users",
              "mail": "sailing-lovers@example.org",
              "display_name": "Sailing Lovers",
              "gid_number": 123,
              "members": [
                {
                  "id": {
                    "idp": "http://localhost:20080",
                    "opaque_id": "testuser"
                  }
                },
                {
                  "idp": "http://localhost:20080",
                  "opaque_id": "testreceivinguser"
                }
              ]
            }
          ]
          EOF
      - name: Start revad
        run: |
          ./cmd/revad/revad -c tests/integration/reva-cli/config/revad-localfs.toml &
          echo $! > revad.pid
          sleep 2
      - name: Run reva CLI tests
        run: make test-reva-cli
      - name: Stop revad
        run: |
          if [ -f revad.pid ]; then
            kill $(cat revad.pid) || true
            rm revad.pid
          fi
        if: always()
