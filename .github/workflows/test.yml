name: Test
on:
  pull_request:
  push:
    tags-ignore:
      - "*"
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Go environment
        uses: actions/setup-go@v3.3.0
        with:
          go-version-file: go.mod
      - name: Test integration
        run: make test-integration
        env:
          REDIS_ADDRESS: redis:6379
    services:
      redis:
        image: registry.cern.ch/docker.io/webhippie/redis
  go-test:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Go environment
        uses: actions/setup-go@v3.3.0
        with:
          go-version-file: go.mod
      - name: Test
        run: make test
  docker:
    strategy:
      fail-fast: false
      matrix:
        image: [reva, revad-eos, revad-ceph]
    uses: ./.github/workflows/docker.yml
    with:
      file: docker/Dockerfile.${{ matrix.image }}
  docker-revad:
    name: docker (revad)
    uses: ./.github/workflows/docker.yml
    with:
      file: docker/Dockerfile.revad
      tag: revad:test
      load: true
  litmus:
    needs: docker-revad
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        profile: [1, 2, 3]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download image
        uses: ishworkh/docker-image-artifact-download@v1
        with:
          image: revad:test
      - name: Test
        run: make litmus-only
        env:
          PROFILE: ${{ matrix.profile }}
          IMAGE: revad:test